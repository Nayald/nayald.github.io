const e=".",t={trainee:[1,4],legacy1:[0,2,3,4],legacy2:[0,1,5,6],legacy11:[1,3],legacy12:[1,2],legacy21:[4,6],legacy22:[4,5]},n=[new Set([3,6,13]),new Set([4,7,12]),new Set([9,25,27]),new Set([14,19,22]),new Set([9,22]),new Set([14,27]),new Set([11,26]),new Set([21,24])],r=["Speed","Stamina","Power","Guts","Wit"],l=["Turf","Dirt","Short","Mile","Medium","Long","Front Runner","Pace Chaser","Late surger","End Closer"],c=[.7,.8,.9],i=[.01,.03,.05],d=[.05,.1,.15],o=[.01,.02,.03],a=[.03,.06,.09],s=[.2,.25,.4],u=Array.from(document.querySelectorAll("#tree-container > .tree-node")),h=Array.from(document.querySelectorAll("#tree-container > .digit-badge.internal")),m=Array.from(document.querySelectorAll("#tree-container > .digit-badge.lineage")),f=document.querySelector("#tree-container > .digit-badge.compatibility"),g=Array.from(document.querySelectorAll("#tree-container > .digit-badge.race")),x=document.getElementById("uma-list"),p=document.getElementById("calandar-modal"),E=Array.from(p.querySelectorAll(".slot")),v=document.getElementById("race-modal"),C=v.querySelector("h2"),y=document.getElementById("race-grid"),L=document.getElementById("spark-modal"),T=document.getElementById("inspiration-table"),w=document.getElementById("inheritance-table"),k=Array.from({length:6},(()=>Array.from({length:3},(()=>new Array(24).fill(null))))),A=Array.from({length:6},(()=>[[0,0],[0,0],[-1,0],new Map,new Map]));let b,S,I,B,M,q,$;function N(e){e.stopPropagation(),ne(e.currentTarget.idx)}let j=null;function D(e){e.currentTarget.classList.add("dragging"),j=e.currentTarget.idx}function P(e){e.currentTarget.classList.remove("dragging"),j=null}(async()=>{[[b,S,I],[B,M],q,$]=await Promise.all([fetch(`${e}/umas.json`).then((e=>e.json())),fetch(`${e}/races.json`).then((e=>e.json())),fetch(`${e}/uniques.json`).then((e=>e.json())),fetch(`${e}/sparks.json`).then((e=>e.json()))]);for(let e=0;e<I.length;++e){let t=0n;for(let n=0;n<I[e].length;++n){if("number"==typeof I[e][n]){t<<=BigInt(48*I[e][n]);continue}const r=atob(I[e][n]);let l=0;for(let e=0;e<r.length;e++)l=256*l+r.charCodeAt(e);t=t<<48n|BigInt(l)}I[e]=t}I[void 0]=0n;for(let t=0;t<b.length;++t){const n=document.createElement("div");n.className="uma-item",n.idx=t;const r=document.createElement("img");r.src=`${e}/umas/${t}.png`,n.appendChild(r);const l=document.createElement("div");l.className="uma-name",l.textContent=b[t],n.appendChild(l);const c=document.createElement("div");c.className="uma-extra";const i=document.createElement("div");i.classList.add("digit-badge","lineage"),i.textContent="",c.appendChild(i);const d=document.createElement("div");d.classList.add("digit-badge","compatibility"),d.textContent="",c.appendChild(d),n.appendChild(c),n.addEventListener("click",N),n.draggable=!0,n.addEventListener("dragstart",D),n.addEventListener("dragend",P),x.appendChild(n)}})();const F=[(e,t)=>e.idx>t.idx,(e,t)=>e.children[1].innerText>t.children[1].innerText?1:-1,(e,t)=>{const n=+e.children[2].children[0].innerText,r=+t.children[2].children[0].innerText,l=n+ +e.children[2].children[1].innerText,c=r+ +t.children[2].children[1].innerText;return(c<l?-1:c>l)||r>n||F[1](e,t)}];let z=0;function G(){const e=[...x.children].sort(F[z]);for(let t=0;t<e.length;++t)x.appendChild(e[t])}function O(e){const t=document.querySelectorAll(".sort-button");for(let e=0;e<t.length;++e)t[e].classList.remove("active");e.currentTarget.classList.add("active"),e.currentTarget.idx!==z&&(z=e.currentTarget.idx,G())}document.querySelectorAll(".sort-button").forEach(((e,t)=>{e.idx=t,e.addEventListener("click",O)}));let R=null;function U(e){R&&R.classList.remove("selected"),R=e,e.classList.add("selected");for(let e=0;e<x.children.length;++e){const n=x.children[e].children[2].children,r=x.children[e].idx===R.idx,l=R===u[1]||R===u[4];let c=!0;for(let n=0;n<t[R.id].length;++n)if(u[t[R.id][n]].idx===x.children[e].idx){c=!1;break}!r&&l&&c&&null!=(R===u[1]?u[4]:u[1]).idx?n[1].textContent=Y(I[(R===u[1]?u[4]:u[1]).idx]&I[x.children[e].idx]):n[1].textContent="",R===u[0]||r||!c?n[0].textContent="":n[0].textContent=l?Y(I[u[0].idx]&I[x.children[e].idx]):x.children[e].idx!==u[0].idx?Y(I[u[0].idx]&I[(R===u[2]||R===u[3]?u[1]:u[4]).idx]&I[x.children[e].idx]):0}2===z&&G()}function W(e){e.currentTarget.classList.add("hover")}function H(e){e.currentTarget.classList.remove("hover")}function J(e){e.stopPropagation(),U(e.currentTarget)}function K(e){e.preventDefault(),e.dataTransfer.dropEffect="copy"}function Q(e){e.currentTarget.classList.add("hover"),U(e.currentTarget)}function V(e){e.currentTarget.classList.remove("hover")}function X(e){e.preventDefault(),j&&ne(j,e.currentTarget)}function Y(e){let t=0,n=0;const r=0xffffffffn;for(;0n!==e;){let l=Number(e&r);for(;0!==l;){const e=l&-l,r=31-Math.clz32(e);t+=S[n+r],l^=e}e>>=32n,n+=32}return t}function Z(e){delete e.idx,e.children[0].src="",e.children[1].textContent=""}function _(){u.forEach((e=>Z(e))),m.forEach((e=>e.textContent=0)),f.textContent=0,h.forEach((e=>e.textContent=0)),U(u[0]),Be()}function ee(...e){let t=0;for(let n=0;n<e.length;++n)t+=+e[n].textContent;return t}function te(){h[0].textContent=ee(...m,f,...g),h[1].textContent=ee(...m.slice(0,3),f,...g.slice(0,2)),h[2].textContent=ee(m[1],g[0]),h[3].textContent=ee(m[2],g[1]),h[4].textContent=ee(...m.slice(3,6),f,...g.slice(2,4)),h[5].textContent=ee(m[4],g[2]),h[6].textContent=ee(m[5],g[3]),Be()}function ne(n,r=null){t[(r=r||R).id].forEach((e=>{u[e].idx===n&&Z(u[e])})),r.idx=n,r.children[0].src=`${e}/umas/${n}.png`,r.children[1].textContent=b[n],m[0].textContent=Y(I[u[0].idx]&I[u[1].idx]),m[3].textContent=Y(I[u[0].idx]&I[u[4].idx]),f.textContent=Y(I[u[1].idx]&I[u[4].idx]),m[1].textContent=u[2].idx!==u[0].idx?Y(I[u[0].idx]&I[u[1].idx]&I[u[2].idx]):0,m[2].textContent=u[3].idx!==u[0].idx?Y(I[u[0].idx]&I[u[1].idx]&I[u[3].idx]):0,m[4].textContent=u[5].idx!==u[0].idx?Y(I[u[0].idx]&I[u[4].idx]&I[u[5].idx]):0,m[5].textContent=u[6].idx!==u[0].idx?Y(I[u[0].idx]&I[u[4].idx]&I[u[6].idx]):0,te();U(u.find((e=>null==e.idx))??r)}function re(e=null,t=null,n=null,r=null,l=null,c=null,i=null){function d(e,t,n,r){if(e===t)return[0,[0,t],[0,n],[0,r]];const l=I[e]&I[t],c=Y(l);if(null!=n&&null!=r){const i=n!==e&&n!==t?Y(l&I[n]):0,d=r!==e&&r!==t?Y(l&I[r]):0;return[c+i+d,[c,t],[i,n],[d,r]]}if(n??=r,null!=n){const r=n!==e&&n!==t?Y(l&I[n]):0;let i=[0,e];for(const[r,c]of I.entries()){if(r===e||r===t||r===n)continue;const d=[Y(l&c),r];d[0]>i[0]&&(i=d)}return[c+r+i[0],[c,t],[r,n],i]}let i=[0,e],d=[-1,null];for(let n=0;n<I.length;++n){if(n===e||n===t)continue;const r=[Y(l&I[n]),n];r[0]>i[0]?(d=i,i=r):r[0]>d[0]&&(d=r)}return[c+i[0]+d[0],[c,t],i,d]}function o(t,n,r=!0){const l=Y(I[t[1][1]]&I[n[1][1]]);return r||([t,n]=t[0]>=n[0]?[t,n]:[n,t]),[e,t[0]+n[0]+l,[l,[t[0]+l,[t[1],t[2],t[3]]],[n[0]+l,[n[1],n[2],n[3]]]]]}if(null==e){let e=[null,-1,[-1,[-1],[-1]]];for(let d=0;d<I.length;++d){const o=re(d,t,n,r,l,c,i);o[1]>e[1]&&(e=o)}return e}if(null!=t&&null!=l)return null==n&&null!=r&&(n=r,r=null),null==c&&null!=i&&(c=i,i=null),o(d(e,t,n,r),d(e,l,c,i));if(null!=l&&(t=l,n=c,r=i),null!=t){null==n&&null!=r&&(n=r,r=null);const l=d(e,t,n,r);let c=[null,-1,[-1,[-1],[-1]]];for(let n=0;n<I.length;++n){if(n===e||n===t)continue;const r=o(l,d(e,n));(r[1]>c[1]||r[2][1][0]+r[2][2][0]>c[2][1][0]+c[2][2][0])&&(c=r)}return c}const a=[];for(let t=0;t<I.length;++t)t!==e&&a.push(d(e,t));let s=[null,-1,[-1,[-1],[-1]]];for(let e=0;e<a.length;++e)for(let t=e+1;t<a.length;++t){const n=o(a[e],a[t],!1);(n[1]>s[1]||n[2][1][0]+n[2][2][0]>s[2][1][0]+s[2][2][0])&&(s=n)}return s}U(u[0]),u.forEach((e=>{e.addEventListener("mouseenter",W),e.addEventListener("mouseleave",H),e.addEventListener("click",J),e.addEventListener("dragover",K),e.addEventListener("dragenter",Q),e.addEventListener("dragleave",V),e.addEventListener("drop",X)})),document.getElementById("search-box").addEventListener("input",(e=>{const t=e.currentTarget.value.toLowerCase();for(let e=0;e<x.children.length;++e)x.children[e].style.display=x.children[e].textContent.toLowerCase().includes(t)?"flex":"none"})),document.getElementById("clear-tree").addEventListener("click",(e=>_())),document.getElementById("fill-best").addEventListener("click",(t=>{const n=re(u[0].idx,u[1].idx,u[2].idx,u[3].idx,u[4].idx,u[5].idx,u[6].idx);u[0].idx=n[0],u[0].children[0].src=`${e}/umas/${n[0]}.png`,u[0].children[1].textContent=b[n[0]];for(const[t,r]of n[2][1][1].entries())u[1+t].idx=r[1],u[1+t].children[0].src=`${e}/umas/${r[1]}.png`,u[1+t].children[1].textContent=b[r[1]],m[t].textContent=r[0];for(const[t,r]of n[2][2][1].entries())u[4+t].idx=r[1],u[4+t].children[0].src=`${e}/umas/${r[1]}.png`,u[4+t].children[1].textContent=b[r[1]],m[3+t].textContent=r[0];f.textContent=n[2][0],te(),U(u[0])}));let le=null,ce=null;function ie(){for(let t=0;t<le[ce.idx].length;++t){E[t].children[0].removeAttribute("src");const n=le[ce.idx][t];null!=n&&(E[t].children[0].src=`${e}/races/${n}.png`)}}function de(e){le=k[e.currentTarget.idx];const t=document.querySelectorAll(".year-tab");for(let e=0;e<t.length;++e)t[e].classList.remove("active");t[0].classList.add("active"),ce=t[0],ie(),p.classList.add("active")}function oe(){for(let e=0;e<2;++e){const t=new Set(k[3*e].flat());t.delete(null);for(let r=0;r<2;++r){const l=t.intersection(new Set(k[3*e+r+1].flat()));let c=l.size;for(let e=0;e<n.length;++e)c+=n[e].isSubsetOf(l);g[2*e+r].textContent=c}}}function ae(e){e.stopPropagation(),e.target===e.currentTarget&&(oe(),p.classList.remove("active"),te())}function se(e){const t=document.querySelectorAll(".year-tab");for(let e=0;e<t.length;++e)t[e].classList.remove("active");e.currentTarget.classList.add("active"),ce=e.currentTarget,ie()}document.querySelectorAll(".calandar-selector").forEach(((e,t)=>{e.idx=t,e.addEventListener("click",de)})),p.addEventListener("click",ae),document.getElementById("close-calandar-modal").addEventListener("click",ae),document.querySelectorAll(".year-tab").forEach(((e,t)=>{e.idx=t,e.addEventListener("click",se)}));let ue=null;function he(t){const n=t.currentTarget.idx;le[ce.idx][ue.idx]=n,ue.children[0].removeAttribute("src"),null!=n&&(ue.children[0].src=`${e}/races/${n}.png`),v.classList.remove("active")}function me(t){ue=t.currentTarget,C.textContent=ce.textContent+" "+t.currentTarget.parentElement.children[1].textContent.split(" ").reverse().join(" "),y.replaceChildren(y.children[0]);const n=M[ce.idx][t.currentTarget.idx];for(let t=0;t<n.length;++t){const r=document.createElement("div");r.classList.add("slot-wrapper");const l=document.createElement("div");l.classList.add("slot"),l.idx=n[t],l.addEventListener("click",he);const c=document.createElement("img");c.src=`${e}/races/${n[t]}.png`,l.appendChild(c);const i=document.createElement("div");i.classList.add("label"),i.textContent=B[n[t]],r.appendChild(l),r.appendChild(i),y.appendChild(r)}v.classList.add("active")}function fe(e,t){const n=e.children[1].children;for(let e=1;e<n.length;++e)n[e].classList.toggle("filled",e<=t)}document.querySelectorAll("#calandar-grid .slot").forEach(((e,t)=>{e.idx=t,e.addEventListener("click",me)})),document.getElementById("race-modal").addEventListener("click",(e=>{e.stopPropagation(),e.target===e.currentTarget&&v.classList.remove("active")})),document.getElementById("close-race-modal").addEventListener("click",(e=>{v.classList.remove("active")})),y.children[0].idx=null,y.children[0].addEventListener("click",he);let ge=null;function xe(e){const t=e.currentTarget.parentElement.parentElement;ge[+t.type+3].set(t.idx,e.currentTarget.idx),fe(t,e.currentTarget.idx)}function pe(e){const t=e.currentTarget.parentElement;ge[3+t.type].delete(t.idx),Ce.removeChild(t)}function Ee(e,t){const n=document.createElement("div");n.className="additional-element",n.type=e,n.idx=t;const r=document.createElement("span");r.className="element-name",r.textContent=(0===e?B:$)[t],n.appendChild(r);const l=document.createElement("div");l.className="stars";for(let e=0;e<3;++e){const t=document.createElement("button");t.className="star",0===e&&t.classList.add("filled"),t.textContent="★",t.idx=e,t.addEventListener("click",xe),l.appendChild(t)}n.appendChild(l);const c=document.createElement("button");return c.className="remove-btn",c.textContent="×",c.addEventListener("click",pe),n.appendChild(c),n}const ve=document.getElementById("main-sparks").children,Ce=document.getElementById("white-sparks");function ye(e){const t=u[1+e.currentTarget.idx].idx;ge=A[e.currentTarget.idx],ve[2].firstElementChild.replaceChildren(ve[2].firstElementChild.firstElementChild);for(let e=0;e<q[t]?.length;++e){const n=document.createElement("option");n.value=e,n.textContent=q[t][e],ve[2].firstElementChild.appendChild(n)}ge[2][0]>=ve[2].firstElementChild.children.length-1&&(ge[2][0]=-1,ge[2][1]=0);for(let e=0;e<ve.length;++e)ve[e].children[0].value=ge[e][0],fe(ve[e],ge[e][1]);Ce.replaceChildren(),ge[3].forEach(((e,t)=>{const n=Ee(0,t);Ce.appendChild(n),fe(n,e)})),ge[4].forEach(((e,t)=>{const n=Ee(1,t);Ce.appendChild(n),fe(n,e)})),we.value="",ke.classList.remove("show"),L.classList.add("active")}function Le(e){ge[e.currentTarget.parentElement.idx][0]=parseInt(e.currentTarget.value)}function Te(e){const t=e.currentTarget.parentElement.parentElement;ge[t.idx][1]=e.currentTarget.idx,fe(t,e.currentTarget.idx)}document.querySelectorAll(".spark-selector").forEach(((e,t)=>{e.idx=t,e.addEventListener("click",ye)})),document.getElementById("spark-modal").addEventListener("click",(e=>{e.stopPropagation(),e.target===e.currentTarget&&(L.classList.remove("active"),ge[3]=new Map(Array.from(ge[3].entries()).sort(((e,t)=>e[0]>t[0]))),ge[4]=new Map(Array.from(ge[4].entries()).sort(((e,t)=>e[0]>t[0]))),Be(),qe())})),document.getElementById("close-spark-modal").addEventListener("click",(e=>{L.classList.remove("active"),ge[3]=new Map(Array.from(ge[3].entries()).sort(((e,t)=>e[0]>t[0]))),ge[4]=new Map(Array.from(ge[4].entries()).sort(((e,t)=>e[0]>t[0]))),Be(),qe()}));for(let e=0;e<ve.length;++e){ve[e].idx=e,ve[e].children[0].addEventListener("change",Le);for(let t=0;t<ve[e].children[1].children.length;++t)ve[e].children[1].children[t].idx=t,ve[e].children[1].children[t].addEventListener("click",Te)}const we=document.getElementById("searchInput"),ke=document.getElementById("suggestions");let Ae=-1;function be(e){const t=e.currentTarget.type,n=e.currentTarget.idx;ge[3+t].has(n)||(ge[3+t].set(n,0),Ce.appendChild(Ee(t,n))),ke.classList.remove("show"),we.value=""}function Se(e){const t=[0,0,0,0,0,0,0];t[0]=1;for(let n=0;n<e.length;n++){const r=e[n],l=1-r;for(let e=n+1;e>=1;e--)t[e]=t[e]*l+t[e-1]*r;t[0]*=l}const n=1-t[0],r=n-t[1],l=r-t[2],c=l-t[3],i=c-t[4];return[n,r,l,c,i,i-t[5]].slice(0,e.length)}function Ie(e,t,n=null){const r=document.createElement("tr");null!=n&&(r.style.backgroundColor=n);var l=document.createElement("td");l.textContent=e,r.appendChild(l);for(let e=0;e<t.length;++e){const n=document.createElement("td");n.textContent="number"==typeof t[e]?(100*t[e]).toFixed(3)+"%":t[e],r.appendChild(n)}T.lastElementChild.appendChild(r)}function Be(){T.lastElementChild.replaceChildren();for(let e=0;e<r.length;++e){let t=[];for(let n=0;n<A.length;++n)A[n][0][0]===e&&t.push(Math.min(1,(1+ +h[1+n].textContent/100)*c[A[n][0][1]]));t.length>0&&Ie(r[e],Se(t),"#37b7f4")}for(let e=0;e<l.length;++e){let t=[];for(let n=0;n<A.length;++n)A[n][1][0]===e&&t.push(Math.min(1,(1+ +h[1+n].textContent/100)*i[A[n][1][1]]));if(t.length>0){t=Se(t);for(let e=3;e<t.length;++e)t[e]="Not Allowed";Ie(l[e],t,"#ff7cb5")}}let e=new Map;for(let t=0;t<A.length;++t){if(-1===A[t][2][0]||null==u[1+t].idx)continue;const n=q[u[1+t].idx][A[t][2][0]],r=Math.min(1,(1+ +h[1+t].textContent/100)*d[A[t][2][1]]);e.has(n)?e.get(n).push(r):e.set(n,[r])}e.forEach(((e,t)=>{Ie(t,Se(e),"#94d331")})),e=new Map;for(let t=0;t<A.length;++t)A[t][3].forEach(((n,r)=>{const l=Math.min(1,(1+ +h[1+t].textContent/100)*o[n]);e.has(r)?e.get(r).push(l):e.set(r,[l])}));Array.from(e.entries()).sort(((e,t)=>e[0]>t[0])).forEach((e=>{Ie(B[e[0]],Se(e[1]))})),e=new Map;for(let t=0;t<A.length;++t)A[t][4].forEach(((n,r)=>{const l=Math.min(1,(1+ +h[1+t].textContent/100)*a[n]);e.has(r)?e.get(r).push(l):e.set(r,[l])}));Array.from(e.entries()).sort(((e,t)=>e[0]>t[0])).forEach((e=>{Ie($[e[0]],Se(e[1]))}))}function Me(e,t){const n=document.createElement("tr");var r=document.createElement("td");r.textContent=e,n.appendChild(r);for(let e=0;e<s.length;++e){const r=document.createElement("td");r.textContent=(100*s[e]*1.1**t).toFixed(2)+"%",n.appendChild(r)}w.lastElementChild.appendChild(n)}function qe(){w.lastElementChild.replaceChildren();let e=new Map;for(let t=0;t<A.length;++t)A[t][3].forEach(((t,n)=>e.set(n,(e.get(n)??0)+1)));Array.from(e.entries()).sort(((e,t)=>e[0]>t[0])).forEach((e=>{Me(B[e[0]],e[1])})),e=new Map;for(let t=0;t<A.length;++t)A[t][4].forEach(((t,n)=>e.set(n,(e.get(n)??0)+1)));Array.from(e.entries()).sort(((e,t)=>e[0]>t[0])).forEach((e=>{Me($[e[0]],e[1])}))}we.addEventListener("keydown",(function(e){"ArrowDown"===e.key?(e.preventDefault(),Ae=Math.min(ke.children.length-1,Ae+1)):"ArrowUp"===e.key?(e.preventDefault(),Ae=Math.max(0,Ae-1)):"Enter"===e.key&&Ae>=0?(e.preventDefault(),ke.children[Ae].click()):"Enter"===e.key&&ke.children.length>0&&(e.preventDefault(),ke.firstElementChild.click())})),we.addEventListener("click",(e=>{e.target.value.trim()&&ke.classList.add("show")})),we.addEventListener("input",(e=>{const t=e.target.value.trim().toLowerCase();if(t){ke.replaceChildren(),Ae=-1;for(let e=0;e<30;++e){if(!B[e].toLowerCase().includes(t))continue;const n=document.createElement("div");n.className="suggestion-item",n.textContent=B[e],n.type=0,n.idx=e,n.addEventListener("click",be),ke.appendChild(n)}for(let e=0;e<$.length;++e){if(!$[e].toLowerCase().includes(t))continue;const n=document.createElement("div");n.className="suggestion-item",n.textContent=$[e],n.type=1,n.idx=e,n.addEventListener("click",be),ke.appendChild(n)}ke.children&&ke.classList.add("show")}else ke.classList.remove("show")})),L.addEventListener("click",(e=>{e.target.closest(".search-container")||ke.classList.remove("show")}));
