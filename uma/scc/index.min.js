const e=".",t=[[1,4],[0,2,3,4],[1,3],[1,2],[0,1,5,6],[4,6],[4,5]],n=[new Set([3,6,13]),new Set([4,7,12]),new Set([9,25,27]),new Set([14,19,22]),new Set([9,22]),new Set([14,27]),new Set([11,26]),new Set([8,20]),new Set([21,24])],r=["Speed","Stamina","Power","Guts","Wit"],a=["Turf","Dirt","Short","Mile","Medium","Long","Front Runner","Pace Chaser","Late surger","End Closer"],l=[.7,.8,.9],c=[.01,.03,.05],s=[.05,.1,.15],d=[.01,.02,.03],i=[.03,.06,.09],o=[.03,.06,.09],u=[.2,.25,.4],m=Array.from(document.querySelectorAll("#tree-container .tree-node")),p=Array.from(document.querySelectorAll("#tree-container .digit-badge.internal")),h=Array.from(document.querySelectorAll("#tree-container .digit-badge.lineage")),g=document.querySelector("#tree-container .digit-badge.compatibility"),f=Array.from(document.querySelectorAll("#tree-container .digit-badge.race")),x=document.getElementById("uma-list"),v=document.getElementById("calandar-modal"),k=Array.from(v.querySelectorAll(".slot")),_=document.getElementById("race-modal"),E=_.querySelector("h2"),C=document.getElementById("race-grid"),y=document.getElementById("spark-modal"),L=document.getElementById("spark-grid"),b=document.getElementById("inspiration-table"),T=document.getElementById("inheritance-table"),A=document.getElementById("load-modal"),w=document.getElementById("stored-umas"),S=new Set,I=[[0,1,4],[1,2,3],[2],[3],[4,5,6],[5],[6]],B=new Map;function N(e=null){return null==e?{idx:null,race_calandar:Array.from({length:3},(()=>new Array(24).fill(null))),blue_spark:[0,0],red_spark:[0,0],green_spark:[-1,0],race_sparks:new Map,skill_sparks:new Map,scenario_sparks:new Map}:{idx:$.indexOf(e.uma_name),race_calandar:e.invariant_race_calandar.map((e=>e.map((e=>null!=e?D.indexOf(e):null)))),blue_spark:e.blue_spark,red_spark:e.red_spark,green_spark:e.green_spark,race_sparks:new Map(e.invariant_race_sparks.map((e=>[D.indexOf(e[0]),e[1]]))),skill_sparks:new Map(e.invariant_skill_sparks.map((e=>[J.indexOf(e[0]),e[1]]))),scenario_sparks:new Map(e.invariant_scenario_sparks.map((e=>[F.indexOf(e[0]),e[1]])))}}const M=m.map((()=>N()));let $,q,O,D,P,j,J,F,U=M[0];function z(e){e.stopPropagation(),e.target===e.currentTarget&&A.classList.remove("active")}function V(e,t){const r=new Set(e.race_calandar.flat());r.delete(null);const a=r.intersection(new Set(t.race_calandar.flat()));let l=a.size;for(let e=0;e<n.length;++e)l+=n[e].isSubsetOf(a);return l}function W(e,t,n=null){const r=document.createElement("div");r.className="spark",null!=n&&(r.style.border=`2px solid ${n}`);const a=document.createElement("span");a.textContent=e,r.appendChild(a);const l=document.createElement("span");return l.classList.add("star","filled"),l.textContent="★".repeat(t+1),r.appendChild(l),r}function G(e){e.stopPropagation();const t=e.currentTarget.parentElement.parentElement;localStorage.removeItem(t.key),B.delete(t.key),w.removeChild(t)}function R(e){const t=B.get(e.currentTarget.key);I[se.idx].forEach(((e,n)=>{n>=t.uma_datas.length||null==t.uma_datas[n]||(Ee(t.uma_datas[n].idx,e),M[e]=structuredClone(t.uma_datas[n]))})),ke(),we(),_e(),Ye(),et(),A.classList.remove("active")}function H(t){const n=document.createElement("div");n.className="body";const l=document.createElement("img");l.src=`${e}/umas/${t.idx}.png`,n.appendChild(l);const c=document.createElement("div");return c.className="sparks",c.appendChild(W(r[t.blue_spark[0]],t.blue_spark[1],"#37b7f4")),c.appendChild(W(a[t.red_spark[0]],t.red_spark[1],"#ff7cb5")),t.green_spark[0]>=0&&c.appendChild(W(j[t.idx][t.green_spark[0]],t.green_spark[1],"#94d331")),t.race_sparks.forEach(((e,t)=>c.appendChild(W(D[t],e)))),t.skill_sparks.forEach(((e,t)=>c.appendChild(W(J[t],e)))),t.scenario_sparks.forEach(((e,t)=>c.appendChild(W(F[t],e)))),n.appendChild(c),n}function K(e){const t=B.get(e),n=document.createElement("div");n.className="stored-uma",n.key=e,n.timestamp=t.timestamp,n.addEventListener("click",R);const r=document.createElement("div");r.className="header";const a=document.createElement("button");a.className="remove-btn",a.textContent="✖",a.addEventListener("click",G),r.appendChild(a);const l=document.createElement("div");l.className="name",l.textContent=t.save_name,r.appendChild(l),n.appendChild(r);let c=t.uma_datas[0].idx!==M[0].idx,s=c?fe(O[M[0].idx]&O[t.uma_datas[0].idx]):0;n.appendChild(H(t.uma_datas[0]));let d=0;for(let e=1;e<t.uma_datas.length;++e){const r=t.uma_datas[e];null!=r&&(s+=c&&r.idx!==M[0].idx?fe(O[M[0].idx]&O[t.uma_datas[0].idx]&O[r.idx]):0,d+=V(t.uma_datas[0],r),n.appendChild(H(r)))}n.value=0;const i=t.uma_datas[0].idx;if(1===se.idx||4===se.idx){const e=1===se.idx?4:1,t=M[e].idx;if(c&&i!==t){const e=document.createElement("div");e.classList.add("digit-badge","lineage"),e.textContent=s,r.appendChild(e),n.value+=+e.textContent;const a=document.createElement("div");a.classList.add("digit-badge","compatibility"),a.textContent=fe(O[t]&O[i]),r.appendChild(a),n.value+=+a.textContent}const a=document.createElement("div");a.classList.add("digit-badge","race"),a.textContent=d,r.appendChild(a),n.value+=+a.textContent}else{const e=2===se.idx||3===se.idx,a=e?2===se.idx?3:2:5===se.idx?6:5,l=e?1:4;if(i!==M[l].idx&&i!==M[a].idx){const e=document.createElement("div");e.classList.add("digit-badge","lineage"),e.textContent=c?fe(O[M[0].idx]&O[M[l].idx]&O[i]):0,r.appendChild(e),n.value+=+e.textContent;const a=document.createElement("div");a.classList.add("digit-badge","race"),a.textContent=V(M[l],t.uma_datas[0]),r.appendChild(a),n.value+=+a.textContent}}return n}(async()=>{[[$,q,O],[D,P],j,[J,F]]=await Promise.all([fetch(`${e}/umas.json`).then((e=>e.json())),fetch(`${e}/races.json`).then((e=>e.json())),fetch(`${e}/uniques.json`).then((e=>e.json())),fetch(`${e}/sparks.json`).then((e=>e.json()))]);for(let e=0;e<O.length;++e){let t=0n;for(let n=0;n<O[e].length;++n){if("number"==typeof O[e][n]){t<<=BigInt(48*O[e][n]);continue}const r=atob(O[e][n]);let a=0;for(let e=0;e<r.length;e++)a=256*a+r.charCodeAt(e);t=t<<48n|BigInt(a)}O[e]=t}O.null=0n;const t=localStorage.getItem("scc_exculded_umas");t&&JSON.parse(t).forEach((e=>S.add($.indexOf(e))));const n=document.createDocumentFragment();for(let t=0;t<$.length;++t){const r=document.createElement("div");r.className="uma-item",r.idx=t;const a=document.createElement("img");a.src=`${e}/umas/${t}.png`,r.appendChild(a);const l=document.createElement("div");l.className="uma-name",l.textContent=$[t],r.appendChild(l);const c=document.createElement("div");c.className="uma-extra";const s=document.createElement("div");s.classList.add("digit-badge","lineage"),s.textContent="",c.appendChild(s);const d=document.createElement("div");d.classList.add("digit-badge","compatibility"),d.textContent="",c.appendChild(d),r.appendChild(c);const i=document.createElement("div");i.className="exclude-button",S.has(t)?(r.classList.add("excluded"),i.textContent="✖"):i.textContent="✔",i.addEventListener("click",re),r.appendChild(i),r.addEventListener("click",Z),r.draggable=!0,r.addEventListener("dragstart",te),r.addEventListener("dragend",ne),n.appendChild(r)}x.appendChild(n);for(let e=0;e<localStorage.length;++e){const t=localStorage.key(e);if(!t.startsWith("scc_")||"scc_exculded_umas"===t)continue;let n=JSON.parse(localStorage.getItem(t));Array.isArray(n)&&(n={save_name:n[0],version:n[1],uma_name:n[2],race_calandar_names:n[3],blue_spark:n[4],red_spark:n[5],green_spark:n[6],race_spark_names:n[7],skill_spark_names:n[8],scenario_spark_names:n[9]},localStorage.setItem(t,JSON.stringify(n))),Object.hasOwn(n,"uma_datas")||(n={save_name:n.save_name,version:n.version,timestamp:Date.now(),uma_datas:[{uma_name:n.uma_name,invariant_race_calandar:n.race_calandar_names,blue_spark:n.blue_spark,red_spark:n.red_spark,green_spark:n.green_spark,invariant_race_sparks:n.race_spark_names,invariant_skill_sparks:n.skill_spark_names,invariant_scenario_sparks:n.scenario_spark_names}]},localStorage.setItem(t,JSON.stringify(n))),B.set(t,{save_name:n.save_name,version:n.version,timestamp:n.timestamp,uma_datas:Array.from(n.uma_datas).map((e=>null!=e?N(e):null))})}})(),document.getElementById("save").addEventListener("click",(e=>{if(null==M[se.idx].idx)return;const t=prompt("Enter a name for the selected uma");if(!t)return;const n=[],r=[];for(let e=0;e<I[se.idx].length;++e){const t=M[I[se.idx][e]];if(null==t.idx){n.push(null),r.push(null);continue}const a=$[t.idx],l=[];for(let e=0;e<t.race_calandar.length;++e){const n=t.race_calandar[e],r=[];for(let e=0;e<n.length;++e)r.push(D[n[e]]);l.push(r)}const{blue_spark:c,red_spark:s,green_spark:d}=t,i=Array.from(t.race_sparks,(([e,t])=>[D[e],t])),o=Array.from(t.skill_sparks,(([e,t])=>[J[e],t])),u=Array.from(t.scenario_sparks,(([e,t])=>[F[e],t]));n.push({uma_name:a,invariant_race_calandar:l,blue_spark:c,red_spark:s,green_spark:d,invariant_race_sparks:i,invariant_skill_sparks:o,invariant_scenario_sparks:u}),r.push(structuredClone(t))}const a="scc_"+crypto.randomUUID(),l=Date.now();localStorage.setItem(a,JSON.stringify({save_name:t,version:1,timestamp:l,uma_datas:n})),B.set(a,{save_name:t,version:1,timestamp:l,uma_datas:r})})),A.addEventListener("click",z),document.getElementById("close-load-modal").addEventListener("click",z);const Q=[(e,t)=>t.timestamp-e.timestamp,(e,t)=>e.firstElementChild.children[1].textContent.localeCompare(t.firstElementChild.children[1].textContent)||Q[0],(e,t)=>t.value-e.value||Q[0]];let X=0;function Y(e){const t=document.querySelectorAll("#load-modal .sort-button");for(let e=0;e<t.length;++e)t[e].classList.remove("active");e.currentTarget.classList.add("active"),e.currentTarget.idx!==X&&(X=e.currentTarget.idx,w.replaceChildren(...Array.from(w.children).sort(Q[X])))}function Z(e){e.stopPropagation(),Ee(e.currentTarget.idx),ke(),we(),_e(),Ye(),et()}document.querySelectorAll("#load-modal .sort-button").forEach(((e,t)=>{e.idx=t,e.addEventListener("click",Y)})),document.getElementById("load").addEventListener("click",(e=>{0!=se.idx&&(w.replaceChildren(...Array.from(B.keys(),K).sort(Q[X])),A.classList.add("active"))}));let ee=null;function te(e){e.currentTarget.classList.add("dragging"),ee=e.currentTarget.idx}function ne(e){e.currentTarget.classList.remove("dragging"),ee=null}function re(e){e.stopPropagation();const t=e.currentTarget.parentElement;S.delete(t.idx)?(t.classList.remove("excluded"),e.currentTarget.textContent="✔"):(t.classList.add("excluded"),S.add(t.idx),e.currentTarget.textContent="✖"),localStorage.setItem("scc_exculded_umas",JSON.stringify(Array.from(S,(e=>$[e]))))}const ae=[(e,t)=>e.idx-t.idx,(e,t)=>e.children[1].innerText.localeCompare(t.children[1].innerText),(e,t)=>{const n=+e.children[2].children[0].innerText,r=+t.children[2].children[0].innerText,a=n+ +e.children[2].children[1].innerText,l=r+ +t.children[2].children[1].innerText;return(l<a?-1:l>a?1:0)||r-n||ae[1](e,t)}];let le=0;function ce(e){const t=document.querySelectorAll(".sidebar-header .sort-button");for(let e=0;e<t.length;++e)t[e].classList.remove("active");e.currentTarget.classList.add("active"),e.currentTarget.idx!==le&&(le=e.currentTarget.idx,x.replaceChildren(...Array.from(x.children).sort(ae[le])))}document.querySelectorAll(".sidebar-header .sort-button").forEach(((e,t)=>{e.idx=t,e.addEventListener("click",ce)}));let se=null;function de(e=null){se&&se.classList.remove("selected"),se=e??m.find((e=>null==M[e.idx].idx))??se,se.classList.add("selected");const n=M[se.idx];for(let e=0;e<x.children.length;++e){const r=x.children[e].children[2].children,a=x.children[e].idx===n.idx,l=se===m[1]||se===m[4],c=t[se.idx].every((t=>M[t].idx!==x.children[e].idx));!a&&l&&c&&null!=(se===m[1]?m[4]:m[1]).idx?r[1].textContent=fe(O[M[1===se.idx?4:1].idx]&O[x.children[e].idx]):r[1].textContent="",se===m[0]||a||!c?r[0].textContent="":r[0].textContent=l?fe(O[M[0].idx]&O[x.children[e].idx]):x.children[e].idx!==M[0].idx?fe(O[M[0].idx]&O[M[2===se.idx||3===se.idx?1:4].idx]&O[x.children[e].idx]):0}2===le&&x.replaceChildren(...Array.from(x.children).sort(ae[le]))}function ie(e){e.currentTarget.classList.add("hover")}function oe(e){e.currentTarget.classList.remove("hover")}function ue(e){e.stopPropagation(),de(e.currentTarget)}function me(e){e.preventDefault(),e.dataTransfer.dropEffect="copy"}function pe(e){e.currentTarget.classList.add("hover"),de(e.currentTarget)}function he(e){e.currentTarget.classList.remove("hover")}function ge(e){e.preventDefault(),ee&&(Ee(ee,e.currentTarget),ke(),we(),_e(),Ye(),et())}function fe(e){let t=0,n=0;const r=0xffffffffn;for(;0n!==e;){let a=Number(e&r);for(;0!==a;){const e=a&-a,r=31-Math.clz32(e);t+=q[n+r],a^=e}e>>=32n,n+=32}return t}function xe(e){Ee(null,e.currentTarget.idx),ke(),we(),_e(),Ye(),et()}function ve(...e){let t=0;for(let n=0;n<e.length;++n)t+=+e[n].textContent;return t}function ke(){g.textContent=fe(O[M[1].idx]&O[M[4].idx]),h[0].textContent=fe(O[M[0].idx]&O[M[1].idx]),h[3].textContent=fe(O[M[0].idx]&O[M[4].idx]),h[1].textContent=M[2].idx!==M[0].idx?fe(O[M[0].idx]&O[M[1].idx]&O[M[2].idx]):0,h[2].textContent=M[3].idx!==M[0].idx?fe(O[M[0].idx]&O[M[1].idx]&O[M[3].idx]):0,h[4].textContent=M[5].idx!==M[0].idx?fe(O[M[0].idx]&O[M[4].idx]&O[M[5].idx]):0,h[5].textContent=M[6].idx!==M[0].idx?fe(O[M[0].idx]&O[M[4].idx]&O[M[6].idx]):0}function _e(){p[0].textContent=ve(...h,g,...f),p[1].textContent=ve(...h.slice(0,3),g,...f.slice(0,2)),p[2].textContent=ve(h[1],f[0]),p[3].textContent=ve(h[2],f[1]),p[4].textContent=ve(...h.slice(3,6),g,...f.slice(2,4)),p[5].textContent=ve(h[4],f[2]),p[6].textContent=ve(h[5],f[3])}function Ee(n,r=null){const a=m[r]??se;null==n?(M[a.idx]=N(),a.children[0].removeAttribute("src"),a.children[1].textContent=""):(t[a.idx].forEach((e=>{M[e].idx===n&&(M[a.idx]=M[e],Ee(null,e))})),M[a.idx].idx=n,a.children[0].src=`${e}/umas/${n}.png`,a.children[1].textContent=$[n]),de()}function Ce(e,t,n,r){if(e===t)return[0,[0,t],[0,n],[0,r]];const a=O[e]&O[t],l=fe(a);if(null!=n&&null!=r){const c=n!==e&&n!==t?fe(a&O[n]):0,s=r!==e&&r!==t?fe(a&O[r]):0;return[l+c+s,[l,t],[c,n],[s,r]]}const c=n??r;if(null!=c){const r=c!==e&&c!==t?fe(a&O[c]):0;let s=[0,e];for(let n=0;n<O.length;++n){if(n===e||n===t||n===c||S.has(n))continue;const r=[fe(a&O[n]),n];r[0]>s[0]&&(s=r)}return null!=n?[l+r+s[0],[l,t],[r,c],s]:[l+r+s[0],[l,t],s,[r,c]]}let s=[0,e],d=[-1,null];for(let n=0;n<O.length;++n){if(n===e||n===t||S.has(n))continue;const r=[fe(a&O[n]),n];r[0]>s[0]?(d=s,s=r):r[0]>d[0]&&(d=r)}return[l+s[0]+d[0],[l,t],s,d]}function ye(e,t,n){const r=fe(O[t[1][1]]&O[n[1][1]]);return[e,t[0]+n[0]+r,[r,[t[0]+r,[t[1],t[2],t[3]]],[n[0]+r,[n[1],n[2],n[3]]]]]}function Le(e,t,n,r,a,l,c){if(null==e){let e=[null,-1,[-1,[-1],[-1]]];for(let s=0;s<O.length;++s){if(S.has(s))continue;const d=Le(s,t,n,r,a,l,c);d[1]>e[1]&&(e=d)}return e}if(null!=t&&null!=a)return ye(e,Ce(e,t,n,r),Ce(e,a,l,c));const s=t??a;if(null!=s){const d=null!=t?Ce(e,t,n,r):Ce(e,a,l,c),i=null!=t?t=>ye(e,d,Ce(e,t,l,c)):t=>ye(e,Ce(e,t,n,r),d);let o=[null,-1,[-1,[-1],[-1]]];for(let t=0;t<O.length;++t){if(t===e||t===s||S.has(t))continue;const n=i(t);(n[1]>o[1]||n[2][1][0]+n[2][2][0]>o[2][1][0]+o[2][2][0])&&(o=n)}return o}const d=[],i=[];for(let t=0;t<O.length;++t)t===e||S.has(t)||(d.push(Ce(e,t,n,r)),i.push(Ce(e,t,l,c)));let o=[null,-1,[-1,[-1],[-1]]];for(let t=0;t<d.length;++t)for(let n=t+1;n<i.length;++n){const r=ye(e,d[t],i[n]);(r[1]>o[1]||r[2][1][0]+r[2][2][0]>o[2][1][0]+o[2][2][0])&&(o=r)}return o}m.forEach(((e,t)=>{e.idx=t,e.addEventListener("mouseenter",ie),e.addEventListener("mouseleave",oe),e.addEventListener("click",ue),e.addEventListener("dragover",me),e.addEventListener("dragenter",pe),e.addEventListener("dragleave",he),e.addEventListener("drop",ge)})),de(),document.getElementById("search-box").addEventListener("input",(e=>{const t=e.currentTarget.value.toLowerCase();for(let e=0;e<x.children.length;++e)x.children[e].style.display=x.children[e].textContent.toLowerCase().includes(t)?"flex":"none"})),document.querySelectorAll(".clear-selector").forEach(((e,t)=>{e.idx=t,e.addEventListener("click",xe)})),document.getElementById("clear-tree").addEventListener("click",(()=>{for(let e=0;e<m.length;++e)Ee(null,e);ke(),we(),_e(),Ye(),et(),de()})),document.getElementById("fill-best").addEventListener("click",(t=>{const n=Le(M[0].idx,M[1].idx,M[2].idx,M[3].idx,M[4].idx,M[5].idx,M[6].idx);M[0].idx=n[0],m[0].children[0].src=`${e}/umas/${n[0]}.png`,m[0].children[1].textContent=$[n[0]],g.textContent=n[2][0];const r=n[2][1][1];for(let e=0;e<r.length;++e)Ee(r[e][1],1+e);const a=n[2][2][1];for(let e=0;e<a.length;++e)Ee(a[e][1],4+e);ke(),_e(),Ye(),de()}));let be=null;function Te(){for(let t=0;t<U.race_calandar[be.idx].length;++t){const n=U.race_calandar[be.idx][t];null!=n?k[t].children[0].src=`${e}/races/${n}.png`:k[t].children[0].removeAttribute("src")}}function Ae(e){U=M[e.currentTarget.idx];const t=document.querySelectorAll(".year-tab");for(let e=0;e<t.length;++e)t[e].classList.remove("active");be=t[0],t[0].classList.add("active"),Te(),v.classList.add("active")}function we(){for(let e=0;e<2;++e)for(let t=0;t<2;++t)f[2*e+t].textContent=V(M[3*e+1],M[3*e+t+2])}function Se(e){e.stopPropagation(),e.target===e.currentTarget&&(we(),_e(),Ye(),v.classList.remove("active"))}function Ie(e){const t=document.querySelectorAll(".year-tab");for(let e=0;e<t.length;++e)t[e].classList.remove("active");e.currentTarget.classList.add("active"),be=e.currentTarget,Te()}document.querySelectorAll(".calandar-selector").forEach(((e,t)=>{e.idx=t,e.addEventListener("click",Ae)})),v.addEventListener("click",Se),document.getElementById("close-calandar-modal").addEventListener("click",Se),document.querySelectorAll(".year-tab").forEach(((e,t)=>{e.idx=t,e.addEventListener("click",Ie)}));let Be=null;function Ne(t){const n=t.currentTarget.idx;U.race_calandar[be.idx][Be.idx]=n,Be.children[0].removeAttribute("src"),null!=n&&(Be.children[0].src=`${e}/races/${n}.png`),_.classList.remove("active")}function Me(t){Be=t.currentTarget,E.textContent=`${be.textContent} ${t.currentTarget.parentElement.children[1].textContent.split(" ").reverse().join(" ")}`,C.replaceChildren(C.children[0]);const n=P[be.idx][t.currentTarget.idx];for(let t=0;t<n.length;++t){const r=document.createElement("div");r.classList.add("slot-wrapper");const a=document.createElement("div");a.classList.add("slot"),a.idx=n[t],a.addEventListener("click",Ne);const l=document.createElement("img");l.src=`${e}/races/${n[t]}.png`,a.appendChild(l);const c=document.createElement("div");c.classList.add("label"),c.textContent=D[n[t]],r.appendChild(a),r.appendChild(c),C.appendChild(r)}_.classList.add("active")}function $e(e){e.stopPropagation(),e.target===e.currentTarget&&_.classList.remove("active")}function qe(e,t){const n=e.children[1].children;for(let e=1;e<n.length;++e)n[e].classList.toggle("filled",e<=t)}function Oe(e){const t=e.currentTarget.parentElement.parentElement;U[t.type].set(t.idx,e.currentTarget.idx),qe(t,e.currentTarget.idx)}function De(e){const t=e.currentTarget.parentElement;U[t.type].delete(t.idx),L.removeChild(t)}function Pe(e,t,n=0){const r=document.createElement("div");r.className="spark",r.type=e,r.idx=t;const a=document.createElement("span");a.className="name",a.textContent=("race_sparks"===e?D:"skill_sparks"===e?J:F)[t],r.appendChild(a);const l=document.createElement("div");l.className="stars";for(let e=0;e<3;++e){const t=document.createElement("button");t.className="star",e<=n&&t.classList.add("filled"),t.textContent="★",t.idx=e,t.addEventListener("click",Oe),l.appendChild(t)}r.appendChild(l);const c=document.createElement("button");return c.className="remove-btn",c.textContent="✖",c.addEventListener("click",De),r.appendChild(c),r}function je(e){U=M[e.currentTarget.idx],L.children[2].firstElementChild.replaceChildren(L.children[2].firstElementChild.firstElementChild);for(let e=0;e<j[U.idx]?.length;++e){const t=document.createElement("option");t.value=e,t.textContent=j[U.idx][e],L.children[2].firstElementChild.appendChild(t)}L.children[0].children[0].value=U.blue_spark[0],qe(L.children[0],U.blue_spark[1]),L.children[1].children[0].value=U.red_spark[0],qe(L.children[1],U.red_spark[1]),U.green_spark[0]>=L.children[2].firstElementChild.children.length-1&&(U.green_spark=[-1,0]),L.children[2].children[0].value=U.green_spark[0],qe(L.children[2],U.green_spark[1]);const t=Array.from(L.children).slice(0,3);U.race_sparks.forEach(((e,n)=>{t.push(Pe("race_sparks",n,e))})),U.skill_sparks.forEach(((e,n)=>{t.push(Pe("skill_sparks",n,e))})),U.scenario_sparks.forEach(((e,n)=>{t.push(Pe("scenario_sparks",n,e))})),L.replaceChildren(...t),ze.value="",Ve.classList.remove("show"),y.classList.add("active")}function Je(e){e.stopPropagation(),e.target===e.currentTarget&&(U.race_sparks=new Map(Array.from(U.race_sparks).sort(((e,t)=>e[0]>t[0]))),U.skill_sparks=new Map(Array.from(U.skill_sparks).sort(((e,t)=>e[0]>t[0]))),U.scenario_sparks=new Map(Array.from(U.scenario_sparks).sort(((e,t)=>e[0]>t[0]))),Ye(),et(),y.classList.remove("active"))}function Fe(e){U[e.currentTarget.parentElement.type][0]=parseInt(e.currentTarget.value)}function Ue(e){const t=e.currentTarget.parentElement.parentElement;U[t.type][1]=e.currentTarget.idx,qe(t,e.currentTarget.idx)}document.querySelectorAll("#calandar-grid .slot").forEach(((e,t)=>{e.idx=t,e.addEventListener("click",Me)})),document.getElementById("race-modal").addEventListener("click",$e),document.getElementById("close-race-modal").addEventListener("click",$e),C.children[0].idx=null,C.children[0].addEventListener("click",Ne),document.querySelectorAll(".spark-selector").forEach(((e,t)=>{e.idx=t,e.addEventListener("click",je)})),document.getElementById("spark-modal").addEventListener("click",Je),document.getElementById("close-spark-modal").addEventListener("click",Je),["blue_spark","red_spark","green_spark"].forEach(((e,t)=>{L.children[t].type=e,L.children[t].children[0].addEventListener("change",Fe);for(let e=0;e<L.children[t].children[1].children.length;++e)L.children[t].children[1].children[e].idx=e,L.children[t].children[1].children[e].addEventListener("click",Ue)}));const ze=document.getElementById("searchInput"),Ve=document.getElementById("suggestions");let We=-1;function Ge(e){const t=e.currentTarget.type,n=e.currentTarget.idx;U[t].has(n)||(U[t].set(n,0),L.appendChild(Pe(t,n))),Ve.classList.remove("show"),ze.value=""}function Re(e,t,n,r=n.length){const a=[];for(let l=0;l<r;++l){if(!n[l].toLowerCase().includes(e)||U[t].has(l))continue;const r=document.createElement("div");r.className="suggestion-item",r.textContent=n[l],r.type=t,r.idx=l,r.addEventListener("click",Ge),a.push(r)}return a}function He(e){const t=e.length,n=Array(t+1).fill(0);n[0]=1;for(let r=0;r<t;++r){const t=e[r],a=1-t;for(let e=r+1;e>=1;--e)n[e]=n[e]*a+n[e-1]*t;n[0]*=a}const r=[];let a=1;for(let e=0;e<t;e++)r.push(a-=n[e]);return r}function Ke(e,t=e.length){for(let n=t;n<e.length;++n)e[n]="Not Allowed";return e}function Qe(e,t,n=null){const r=document.createElement("tr");null!=n&&(r.style.backgroundColor=n);var a=document.createElement("td");a.textContent=e,r.appendChild(a);for(let e=0;e<t.length;++e){const n=document.createElement("td");n.textContent="number"==typeof t[e]?Math.max(0,100*t[e]).toFixed(3)+"%":t[e],r.appendChild(n)}return r}function Xe(e,t){const n=new Map;for(let r=1;r<M.length;++r)M[r][e].forEach(((e,a)=>{const l=Math.min(1,(1+ +p[r].textContent/100)*t[e]);n.has(a)?n.get(a).push(l):n.set(a,[l])}));return n}function Ye(){const e=[];for(let t=0;t<r.length;++t){const n=[];for(let e=1;e<M.length;++e)M[e].blue_spark[0]===t&&n.push(Math.min(1,(1+ +p[e].textContent/100)*l[M[e].blue_spark[1]]));n.length>0&&e.push(Qe(r[t],He(n),"#37b7f4"))}for(let t=0;t<a.length;++t){const n=[];for(let e=1;e<M.length;++e)M[e].red_spark[0]===t&&n.push(Math.min(1,(1+ +p[e].textContent/100)*c[M[e].red_spark[1]]));n.length>0&&e.push(Qe(a[t],Ke(He(n),3),"#ff7cb5"))}const t=new Map;for(let e=1;e<M.length;++e){if(null==M[e].idx||-1===M[e].green_spark[0])continue;const n=j[M[e].idx][M[e].green_spark[0]],r=Math.min(1,(1+ +p[e].textContent/100)*s[M[e].green_spark[1]]);t.has(n)?t.get(n).push(r):t.set(n,[r])}t.forEach(((t,n)=>e.push(Qe(n,He(t),"#94d331")))),Array.from(Xe("race_sparks",d)).sort(((e,t)=>e[0]-t[0])).forEach((t=>{e.push(Qe(D[t[0]],He(t[1])))})),Array.from(Xe("skill_sparks",i)).sort(((e,t)=>e[0]-t[0])).forEach((t=>{e.push(Qe(J[t[0]],He(t[1])))})),Array.from(Xe("scenario_sparks",o)).sort(((e,t)=>e[0]-t[0])).forEach((t=>{e.push(Qe(F[t[0]],Ke(He(t[1]),3)))})),b.lastElementChild.replaceChildren(...e)}function Ze(e,t){const n=new Map;for(let t=0;t<M.length;++t)M[t][e].forEach(((e,t)=>n.set(t,(n.get(t)??0)+1)));const r=Array.from(n).sort(((e,t)=>e[0]-t[0])),a=[];for(let n=0;n<r.length;++n){const l=document.createElement("tr"),c=document.createElement("td");c.textContent=t[r[n][0]],l.appendChild(c);for(let t=0;t<u.length-2*("skill_sparks"!==e);++t){const e=document.createElement("td");e.textContent=(100*u[t]*1.1**r[n][1]).toFixed(2)+"%",l.appendChild(e)}a.push(l)}return a}function et(){T.lastElementChild.replaceChildren(...Ze("race_sparks",D),...Ze("skill_sparks",J),...Ze("scenario_sparks",F))}ze.addEventListener("keydown",(function(e){"ArrowDown"===e.key?(e.preventDefault(),We>=0&&Ve.children[We].classList.remove("selected"),We=Math.min(Ve.children.length-1,We+1),Ve.children[We].classList.add("selected"),Ve.children[We].scrollIntoView({block:"nearest",behavior:"smooth"})):"ArrowUp"===e.key?(e.preventDefault(),Ve.children[We].classList.remove("selected"),We=Math.max(0,We-1),Ve.children[We].classList.add("selected"),Ve.children[We].scrollIntoView({block:"nearest",behavior:"smooth"})):"Enter"===e.key&&We>=0?(e.preventDefault(),Ve.children[We].click()):"Enter"===e.key&&Ve.children.length>0&&(e.preventDefault(),Ve.firstElementChild.click())})),ze.addEventListener("click",(e=>{e.target.value.trim()&&Ve.classList.add("show")})),ze.addEventListener("input",(e=>{const t=e.target.value.trim().toLowerCase();if(!t)return void Ve.classList.remove("show");const n=Re(t,"race_sparks",D,30),r=Re(t,"skill_sparks",J),a=Re(t,"scenario_sparks",F);Ve.replaceChildren(...n,...r,...a),Ve.children&&(We=-1,Ve.classList.add("show"))})),y.addEventListener("click",(e=>{e.target.closest(".search-container")||Ve.classList.remove("show")}));